<script type="text/javascript">
  RED.nodes.registerType('ai-agent', {
    category: 'AI Agent',
    color: '#a6bbcf',
    defaults: {
      name: { value: '' },
      agentType: { 
        value: 'assistant', 
        required: true,
        validate: function(val) {
          return ['assistant', 'chatbot', 'openrouter'].includes(val);
        }
      },
      responseType: { 
        value: 'text', 
        required: true,
        validate: function(val) {
          return ['text', 'object'].includes(val);
        }
      }
    },
    inputs: 1,
    outputs: 1,
    icon: './icon.svg',
    label: function() {
      return this.name || 'AI Agent';
    },
    paletteLabel: 'AI Agent',
    oneditprepare: function() {
      // Show/hide settings based on agent type
      $('#node-input-agentType').on('change', function() {
        if ($(this).val() === 'openrouter') {
          $('#openrouter-help').show();
        } else {
          $('#openrouter-help').hide();
        }
      });
      
      // Trigger change to set initial state
      $('#node-input-agentType').trigger('change');
    }
  });
</script>

<!-- START: Template -->
<script type="text/x-red" data-template-name="ai-agent">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="AI Agent">
  </div>
  
  <div class="form-row">
    <label for="node-input-agentType"><i class="fa fa-robot"></i> Agent Type</label>
    <select id="node-input-agentType" style="width: 100%;">
      <option value="assistant">Assistant (Simple Rules)</option>
      <option value="chatbot">Chatbot (Simple Rules)</option>
      <option value="openrouter">OpenRouter (AI-Powered)</option>
    </select>
  </div>
  
  <div class="form-row">
    <label for="node-input-responseType"><i class="fa fa-reply"></i> Response Format</label>
    <select id="node-input-responseType" style="width: 100%;">
      <option value="text">Text Only</option>
      <option value="object">Structured Object</option>
    </select>
  </div>
  
  <div id="openrouter-help" class="form-tips" style="display: none; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #3b78e7;">
    <p><i class="fa fa-info-circle"></i> <strong>Note:</strong> When using OpenRouter, connect an AI Model node to provide the model and API key configuration.</p>
    <p>The AI Model node will add an <code>aiagent</code> property to the message with the required configuration.</p>
  </div>
</script>
<!-- END: Template -->

<!-- START: Help -->
<script type="text/x-red" data-help-name="ai-agent">
  <h3>AI Agent Node</h3>
  <p>An intelligent agent that processes and responds to messages with configurable behavior.</p>
  
  <h4>Features</h4>
  <ul>
    <li>Multiple agent types (Assistant, Chatbot)</li>
    <li>Configurable response formats</li>
    <li>Conversation context tracking</li>
    <li>Error handling and status reporting</li>
  </ul>
  
  <h4>Usage</h4>
  <ol>
    <li>Connect the node to a message source (e.g., HTTP input, inject node)</li>
    <li>Configure the agent type and response format</li>
    <li>Process the response in your flow</li>
  </ol>
  
  <h4>Output Formats</h4>
  <p><b>Text Only:</b> Simple string response</p>
  <p><b>Structured Object:</b> Detailed response including metadata and context</p>
  
  <h4>Examples</h4>
  <p><b>Input:</b> "Hello"</p>
  <p><b>Assistant Output:</b> "Hello! How can I assist you today?"</p>
  <p><b>Chatbot Output:</b> "Hi there! What would you like to chat about?"</p>
</script>
<!-- END: Help -->